{% extends "index.html" %}
{% block body %}
{{ super() }}
<section class="welcome-section">
    <div class="container name-container">
        <img src="{{ url_for('static', path='images/f1.png') }}" alt="" class="moon-img result">
        <img src="{{ url_for('static', path='images/f2.png') }}" alt="" class="circle-moon-img">
        <div class="welcome-background-angles-img">
            <img src="{{ url_for('static', path='images/background_angles_1.png') }}" alt=""
                 class="welcome-background-angles img-2">
            <img src="{{ url_for('static', path='images/background_angles_2.png') }}" alt=""
                 class="welcome-background-angles img-1">
            <img src="{{ url_for('static', path='images/background_angles_3.png') }}" alt=""
                 class="welcome-background-angles img-3">
            <img src="{{ url_for('static', path='images/background_angles_4.png') }}" alt=""
                 class="welcome-background-angles img-4">
        </div>
        <div class="welcome-logotype demo">
            <img src="{{ url_for('static', path='images/Moon.svg')}}" alt="logo" class="welcome-page-logo">
            <h2 class="name-page-description">ваш результат</h2>
            <div class="neurology-5-result-container">
                <h3 class="neurology-5-result-title"></h3>
                <p class="neurology-5-result-1"></p>
                <br/>
                <p class="neurology-5-result-2"></p>
            </div>
        </div>
        <div class="welcome-hero"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script async>
        const day = localStorage.getItem("day");
        const month = localStorage.getItem("month");
        const year = localStorage.getItem("year");
        const name = localStorage.getItem("name");
        const gender = localStorage.getItem("gender");
        if (day && month && year && name && gender) {
            const data = {
                day: day,
                month: month,
                year: year,
                name: name,
                gender: gender,
            }
            axios.post("/get_demo_result", data).then((response) => {
                name_description_element = document.querySelector(".neurology-5-result-container");
                name_description_element.innerHTML = response.data.name_description;
            })
        }
        const startApp = async () => {
            try {
                let tg = window.Telegram.WebApp;
                const user_name = tg.initDataUnsafe.user.username;
                if (user_name) {
                    const user_data = {
                        username: user_name,
                    };
                    const response = await axios.post("/get_user", user_data, {
                        withCredentials: true,
                    });
                    console.log(response)
                    if (response.status === 200 && response.data) {
                        if (response.data.transcripts > 0) {
                            let transcripts_name = ''
                            if (response.data.transcripts === 1) {
                                transcripts_name = 'разбор';
                            } else if (response.data.transcripts % 10 === 1 && response.data.transcripts % 100 !== 11) {
                                transcripts_name = 'разбор';
                            } else if (response.data.transcripts % 10 >= 2 && response.data.transcripts % 10 <= 4 && (response.data.transcripts % 100 < 10 || response.data.transcripts % 100 >= 20)) {
                                transcripts_name = 'разбора';
                            } else {
                                transcripts_name = 'разборов';
                            }
                            const element = document.querySelector(".welcome-hero");
                            element.innerHTML =
                                `<p class="neurology-6-input-text">У вас есть ${response.data.transcripts} ${transcripts_name}.</p>` +
                                '<button class="neurology-1-start-button name"><p onclick=get_full_information() class="neurology-1-start-button-text name">Посмотреть полную версию</p></button>' +
                                '<p class="welcome-footer-description"></p>'
                        } else {
                            const element = document.querySelector(".welcome-hero");
                            element.innerHTML =
                                '<p class="neurology-6-input-text">Чтобы получить подробную информацию о своей Матрице Судьбы, пожалуйста, приобретите полную версию.</p>' +
                                '<button class="neurology-1-start-button name">' +
                                '<p onclick="buy_full_information()" class="neurology-1-start-button-text name">Оплатить полную версию</p>' +
                                '</button>' +
                                '<p class="welcome-footer-description"></p>';

                        }
                    }
                }
            } catch (error) {
                console.log(error);
            }
        };

        startApp();

        const buy_full_information = async () => {
            if (day && month && year && name && gender) {
                const user_name = tg.initDataUnsafe.user.username;
                const data = {
                    username: user_name,
                    data: {
                        day: day,
                        month: month,
                        year: year,
                        name: name,
                        gender: gender,
                    }
                }
                await axios.post("/buy_product", data).then((response) => {
                    if (response.status === 200) {
                        console.log(response.data.url);
                        const botToken = "6778034404:AAFSfCOqtCnEHQq8zU_DEOWw3FECd0xOYfc";
                        const endpoint = `https://api.telegram.org/bot${botToken}/sendInvoice`;

                        const data = {
                            chat_id: 1509045389,
                            title: "title",
                            description: "Your description here",
                            payload: "your_key_here",
                            provider_token: '381764678:TEST:74174',
                            start_parameter: "start_parameter",
                            currency: "RUB",
                            prices: [{label: 'Total Price', amount: 10000}],
                        };
                        tg.openInvoice(endpoint, data);
                    } else {
                        const error_element = document.querySelector(".welcome-footer-description");
                        error_element.style.color = "red";
                        error_element.style.fontSize = "18px";
                        error_element.innerText = "У вас нет разборов";
                    }
                })
            }
        }

        const get_full_information = async () => {
            if (day && month && year && name && gender) {
                const user_name = tg.initDataUnsafe.user.username;
                const data = {
                    day: day,
                    month: month,
                    year: year,
                    name: name,
                    gender: gender,
                    username: user_name,
                }
                await axios.post("/get_full_result", data).then((response) => {
                    if (response.status === 200 && response.data.name_description) {
                        name_description_element = document.querySelector(".neurology-5-result-container");
                        name_description_element.innerHTML = response.data.name_description;
                        startApp()
                    } else {
                        const error_element = document.querySelector(".welcome-footer-description");
                        error_element.style.color = "red";
                        error_element.style.fontSize = "18px";
                        error_element.innerText = "У вас нет разборов";
                    }
                })
            }
        }
    </script>
</section>
{% endblock %}